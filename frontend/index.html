<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>T·∫°o m√£ k√≠ch ho·∫°t</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script defer src="genkey.js"></script>
  <script defer src="unified-auth.js"></script>
  <style>
    /* gi·ªØ nguy√™n style c≈© */
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #4e54c8, #8f94fb);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      min-height: 100vh; padding: 20px;
    }
    .card {
      background-color: #fff;
      padding: 40px 30px;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      width: 100%; max-width: 450px; text-align: center; margin-bottom: 20px;
    }
    h2 { margin-top: 0; margin-bottom: 20px; font-size: 1.8rem; color: #333; }
    label { display: block; text-align: left; margin-bottom: 5px; font-weight: 500; color: #555; }
    input[type="text"], input[type="date"], textarea {
      width: 100%; padding: 15px; margin-bottom: 15px;
      border: 1px solid #ccc; border-radius: 10px; font-size: 1rem;
      transition: 0.2s; resize: vertical; min-height: 80px;
    }
    input:focus, textarea:focus { border-color: #4e54c8; outline: none; }
    button {
      width: 100%; padding: 15px;
      background: #4e54c8; color: white; font-size: 1rem;
      border: none; border-radius: 10px;
      cursor: pointer; transition: background 0.3s ease; margin-bottom: 15px;
    }
    button:hover:not(:disabled) { background: #3b3fbd; }
    button:disabled {
        background: #cccccc;
        cursor: not-allowed;
    }
    .history-button {
      width: auto; display: inline-block; margin-bottom: 20px;
      background: #3498db; padding: 10px 20px; border-radius: 8px; font-size: 0.9rem;
    }
    .history-button:hover { background: #2980b9; }
    .history-container {
      display: none; margin-top: 0; text-align: left; max-height: 300px;
      overflow-y: auto; border: 1px solid #ddd; border-radius: 10px;
      padding: 15px; background-color: #f9f9f9;
      width: 100%; max-width: 450px;
    }
    .history-container h3 { margin: 0 0 15px; color: #333; font-size: 1.2rem; }
    .history-item { padding: 10px 0; border-bottom: 1px solid #eee; }
    .history-item:last-child { border-bottom: none; }
    .history-item .date { font-weight: bold; color: #3498db; font-size: 0.9rem; margin-bottom: 5px; }
    .history-item .input { color: #7f8c8d; font-size: 0.9rem; margin-bottom: 5px; }
    .history-item .key { word-break: break-word; color: #2c3e50; font-size: 0.9rem; }
    #historyButtons { margin-top: 15px; text-align: center; }
    .clear-history {
      width: auto; display: inline-block; margin-top: 0;
      background: #e74c3c; color: white; border: none;
      padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.8rem;
    }
    .clear-history:hover { background: #c0392b; }
    #logoutBtn {
        background: #e74c3c;
        margin-top: 10px;
    }
    #logoutBtn:hover {
        background: #c0392b;
    }
  </style>
</head>
<body>
  <div class="card" id="keyGenTool">
    <h2>üîê C√¥ng C·ª• T·∫°o M√£ K√≠ch Ho·∫°t</h2>
    <label for="serialInput">Serial (client g·ª≠i):</label>
    <input type="text" id="serialInput" placeholder="Nh·∫≠p serial..." autocomplete="off" />
    <label for="expireInput">Ng√†y h·∫øt h·∫°n:</label>
    <input type="date" id="expireInput" />
    <button id="generateBtn">üéØ T·∫°o m√£ k√≠ch ho·∫°t</button>
    <label for="result">K·∫øt qu·∫£:</label>
    <textarea id="result" readonly></textarea>
    <button id="logoutBtn" onclick="logout()">ƒêƒÉng xu·∫•t</button>
  </div>

  <button class="history-button" onclick="toggleHistory()" id="historyToggleButton">üìú L·ªãch s·ª≠ k√≠ch ho·∫°t</button>
  <div id="historyContainer" class="history-container">
    <h3>L·ªãch s·ª≠ k√≠ch ho·∫°t</h3>
    <div id="historyItems">ƒêang t·∫£i l·ªãch s·ª≠...</div>
    <div id="historyButtons">
      <button class
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>T·∫°o m√£ k√≠ch ho·∫°t</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script defer src="genkey.js"></script>
  <script defer src="unified-auth.js"></script>
  <style>
    /* gi·ªØ nguy√™n style c≈© */
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #4e54c8, #8f94fb);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      min-height: 100vh; padding: 20px;
    }
    .card {
      background-color: #fff;
      padding: 40px 30px;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      width: 100%; max-width: 450px; text-align: center; margin-bottom: 20px;
    }
    h2 { margin-top: 0; margin-bottom: 20px; font-size: 1.8rem; color: #333; }
    label { display: block; text-align: left; margin-bottom: 5px; font-weight: 500; color: #555; }
    input[type="text"], input[type="date"], textarea {
      width: 100%; padding: 15px; margin-bottom: 15px;
      border: 1px solid #ccc; border-radius: 10px; font-size: 1rem;
      transition: 0.2s; resize: vertical; min-height: 80px;
    }
    input:focus, textarea:focus { border-color: #4e54c8; outline: none; }
    button {
      width: 100%; padding: 15px;
      background: #4e54c8; color: white; font-size: 1rem;
      border: none; border-radius: 10px;
      cursor: pointer; transition: background 0.3s ease; margin-bottom: 15px;
    }
    button:hover:not(:disabled) { background: #3b3fbd; }
    button:disabled {
        background: #cccccc;
        cursor: not-allowed;
    }
    .history-button {
      width: auto; display: inline-block; margin-bottom: 20px;
      background: #3498db; padding: 10px 20px; border-radius: 8px; font-size: 0.9rem;
    }
    .history-button:hover { background: #2980b9; }
    .history-container {
      display: none; margin-top: 0; text-align: left; max-height: 300px;
      overflow-y: auto; border: 1px solid #ddd; border-radius: 10px;
      padding: 15px; background-color: #f9f9f9;
      width: 100%; max-width: 450px;
    }
    .history-container h3 { margin: 0 0 15px; color: #333; font-size: 1.2rem; }
    .history-item { padding: 10px 0; border-bottom: 1px solid #eee; }
    .history-item:last-child { border-bottom: none; }
    .history-item .date { font-weight: bold; color: #3498db; font-size: 0.9rem; margin-bottom: 5px; }
    .history-item .input { color: #7f8c8d; font-size: 0.9rem; margin-bottom: 5px; }
    .history-item .key { word-break: break-word; color: #2c3e50; font-size: 0.9rem; }
    #historyButtons { margin-top: 15px; text-align: center; }
    .clear-history {
      width: auto; display: inline-block; margin-top: 0;
      background: #e74c3c; color: white; border: none;
      padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.8rem;
    }
    .clear-history:hover { background: #c0392b; }
    #logoutBtn {
        background: #e74c3c;
        margin-top: 10px;
    }
    #logoutBtn:hover {
        background: #c0392b;
    }
  </style>
</head>
<body>
  <div class="card" id="keyGenTool">
    <h2>üîê C√¥ng C·ª• T·∫°o M√£ K√≠ch Ho·∫°t</h2>
    <label for="serialInput">Serial (client g·ª≠i):</label>
    <input type="text" id="serialInput" placeholder="Nh·∫≠p serial..." autocomplete="off" />
    <label for="expireInput">Ng√†y h·∫øt h·∫°n:</label>
    <input type="date" id="expireInput" />
    <button id="generateBtn">üéØ T·∫°o m√£ k√≠ch ho·∫°t</button>
    <label for="result">K·∫øt qu·∫£:</label>
    <textarea id="result" readonly></textarea>
    <button id="logoutBtn" onclick="logout()">ƒêƒÉng xu·∫•t</button>
  </div>

  <button class="history-button" onclick="toggleHistory()" id="historyToggleButton">üìú L·ªãch s·ª≠ k√≠ch ho·∫°t</button>
  <div id="historyContainer" class="history-container">
    <h3>L·ªãch s·ª≠ k√≠ch ho·∫°t</h3>
    <div id="historyItems">ƒêang t·∫£i l·ªãch s·ª≠...</div>
    <div id="historyButtons">
      <button class="clear-history" onclick="clearHistory()">X√≥a l·ªãch s·ª≠</button>
    </div>
  </div>

  <script>
    // Ki·ªÉm tra ƒëƒÉng nh·∫≠p, n·∫øu ch∆∞a chuy·ªÉn v·ªÅ trang auth
    document.addEventListener("DOMContentLoaded", () => {
      if (!checkAuthStatus()) {
        window.location.href = "/auth.html";
      } else {
        loadBalanceAndToggleButton();
        loadHistory();
      }
    });

    // Gi·ªõi h·∫°n t·∫°o m√£ khi s·ªë d∆∞ d∆∞·ªõi 50,000 (gi·∫£ s·ª≠ API /api/balance tr·∫£ v·ªÅ JSON {balance: number})
    async function loadBalanceAndToggleButton() {
      const generateBtn = document.getElementById("generateBtn");
      try {
        const res = await fetch("/api/balance");
        if (!res.ok) throw new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c s·ªë d∆∞");
        const data = await res.json();

        if (data.balance < 50000) {
          generateBtn.disabled = true;
          Swal.fire({
            icon: "warning",
            title: "S·ªë d∆∞ kh√¥ng ƒë·ªß",
            text: "S·ªë d∆∞ hi·ªán t·∫°i nh·ªè h∆°n 50,000, b·∫°n kh√¥ng th·ªÉ t·∫°o m√£ m·ªõi.",
          });
        } else {
          generateBtn.disabled = false;
        }
      } catch (error) {
        console.error(error);
        Swal.fire("L·ªói", "Kh√¥ng th·ªÉ ki·ªÉm tra s·ªë d∆∞.", "error");
      }
    }

    // L·ªãch s·ª≠ k√≠ch ho·∫°t l∆∞u localStorage, l·∫•y ra v√† hi·ªÉn th·ªã
    function loadHistory() {
      const container = document.getElementById("historyItems");
      const history = JSON.parse(localStorage.getItem("activationHistory") || "[]");
      if (history.length === 0) {
        container.innerHTML = "<p>Ch∆∞a c√≥ l·ªãch s·ª≠.</p>";
        return;
      }
      container.innerHTML = "";
      history.forEach(item => {
        const div = document.createElement("div");
        div.classList.add("history-item");
        div.innerHTML = `
          <div class="date">${new Date(item.date).toLocaleString()}</div>
          <div class="input"><strong>Serial:</strong> ${item.serial}<br/><strong>Expire:</strong> ${item.expire}</div>
          <div class="key"><strong>Key:</strong> ${item.key}</div>
        `;
        container.appendChild(div);
      });
    }

    function toggleHistory() {
      const container = document.getElementById("historyContainer");
      const btn = document.getElementById("historyToggleButton");
      if (container.style.display === "block") {
        container.style.display = "none";
        btn.textContent = "üìú L·ªãch s·ª≠ k√≠ch ho·∫°t";
      } else {
        container.style.display = "block";
        btn.textContent = "‚ùå ƒê√≥ng l·ªãch s·ª≠";
      }
    }

    function clearHistory() {
      Swal.fire({
        title: "X√≥a l·ªãch s·ª≠?",
        text: "B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ k√≠ch ho·∫°t?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "C√≥, x√≥a",
        cancelButtonText: "H·ªßy"
      }).then((result) => {
        if (result.isConfirmed) {
          localStorage.removeItem("activationHistory");
          loadHistory();
          Swal.fire("ƒê√£ x√≥a!", "L·ªãch s·ª≠ ƒë√£ ƒë∆∞·ª£c x√≥a.", "success");
        }
      });
    }
  </script>
</body>
</html>
