// --- Content for frontend/admin.html ---
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Key Approval</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
</head>
<body>
  <div class="container py-5">
    <h2 class="mb-4">Admin Panel - Duyệt Key</h2>
    <form id="loginForm" class="mb-4">
      <div class="mb-3">
        <label for="username" class="form-label">Username</label>
        <input type="text" class="form-control" id="username" required />
      </div>
      <div class="mb-3">
        <label for="password" class="form-label">Password</label>
        <input type="password" class="form-control" id="password" required />
      </div>
      <button type="submit" class="btn btn-primary">Đăng nhập</button>
    </form>

    <div id="mainPanel" style="display: none;">
      <h4>Danh sách yêu cầu cấp key</h4>
      <table class="table table-bordered mt-3">
        <thead>
          <tr>
            <th>ID</th>
            <th>Hardware ID</th>
            <th>Request Time</th>
            <th>Trạng thái</th>
            <th>Hành động</th>
          </tr>
        </thead>
        <tbody id="requestTable"></tbody>
      </table>
    </div>
  </div>

  <script>
    // --- Frontend JavaScript (admin.js logic) ---
    const apiBase = 'http://localhost:3000'; // Base URL for your backend API
    let token = ''; // Variable to store the admin authentication token

    // Event listener for the login form submission
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault(); // Prevent default form submission
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      try {
        // Send login request to the backend
        const res = await fetch(`${apiBase}/api/admin/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await res.json();

        if (res.ok) {
          // If login is successful, store the token and show the main panel
          token = data.token;
          document.getElementById('loginForm').style.display = 'none';
          document.getElementById('mainPanel').style.display = 'block';
          loadRequests(); // Load pending requests
        } else {
          // If login fails, show an alert
          alert(data.message || 'Đăng nhập thất bại');
        }
      } catch (error) {
        console.error('Login error:', error);
        alert('Đã xảy ra lỗi khi đăng nhập.');
      }
    });

    // Function to load pending key requests from the backend
    async function loadRequests() {
      try {
        const res = await fetch(`${apiBase}/api/admin/requests`, {
          headers: { Authorization: `Bearer ${token}` } // Include the auth token
        });

        if (!res.ok) {
             // Handle unauthorized or other errors
            if (res.status === 401 || res.status === 403) {
                alert('Phiên đăng nhập đã hết hạn hoặc không có quyền. Vui lòng đăng nhập lại.');
                // Optionally redirect to login or show login form again
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('mainPanel').style.display = 'none';
                token = ''; // Clear token
            } else {
                 alert(`Lỗi khi tải yêu cầu: ${res.status}`);
            }
            return; // Stop execution if fetch failed
        }

        const data = await res.json();
        const tbody = document.getElementById('requestTable');
        tbody.innerHTML = ''; // Clear existing table rows

        // Populate the table with request data
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">Không có yêu cầu nào đang chờ duyệt.</td></tr>';
        } else {
            data.forEach((req) => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${req.id}</td>
                <td>${req.hardwareId}</td>
                <td>${new Date(req.timestamp).toLocaleString()}</td>
                <td>${req.status}</td>
                <td>
                  <button class="btn btn-success btn-sm" onclick="handleAction(${req.id}, 'approve')">Duyệt</button>
                  <button class="btn btn-danger btn-sm" onclick="handleAction(${req.id}, 'reject')">Từ chối</button>
                </td>
              `;
              tbody.appendChild(row);
            });
        }
      } catch (error) {
        console.error('Error loading requests:', error);
        alert('Đã xảy ra lỗi khi tải danh sách yêu cầu.');
      }
    }

    // Unified function to handle approve/reject actions
    async function handleAction(id, action) {
        if (!confirm(`Bạn có chắc chắn muốn ${action === 'approve' ? 'duyệt' : 'từ chối'} yêu cầu ID ${id}?`)) {
            return; // User cancelled
        }

        try {
            const res = await fetch(`${apiBase}/api/admin/${action}/${id}`, {
              method: 'POST',
              headers: { Authorization: `Bearer ${token}` } // Include the auth token
            });

            if (res.ok) {
              // If action is successful, reload the requests list
              loadRequests();
            } else {
              const data = await res.json();
              alert(`Thao tác ${action === 'approve' ? 'duyệt' : 'từ chối'} thất bại: ${data.message || res.statusText}`);
            }
        } catch (error) {
            console.error(`Error performing ${action} action:`, error);
            alert(`Đã xảy ra lỗi khi thực hiện thao tác ${action === 'approve' ? 'duyệt' : 'từ chối'}.`);
        }
    }

    // Note: The original approve/reject functions are replaced by handleAction
    // function approve(id) { ... }
    // function reject(id) { ... }

  </script>
</body>
</html>